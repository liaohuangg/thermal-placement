# 排除解约束梳理说明

本文档梳理了 `constraints_solution_2.lp` 文件中的排除解约束，这些约束用于确保新解与之前所有解的距离都不同。

## 约束结构概览

排除解约束的核心逻辑：
1. **计算当前解的距离**：使用grid坐标计算chiplet对之间的曼哈顿距离
2. **计算距离差**：当前解的距离与之前解的距离的差值
3. **判断是否相同**：通过Big-M方法判断距离差是否小于阈值
4. **顶层约束**：至少有一对chiplet的距离与之前所有解都不同

---

## 一、计算当前解的距离（Grid坐标）

### 1.1 Grid坐标差的绝对值（X方向）

**约束名称**：`dx_grid_abs_pair_pos_c0_0_1` 和 `dx_grid_abs_pair_neg_c0_0_1`

**LP文件中的约束**（第37-40行）：
```
dx_grid_abs_pair_neg_c0_0_1: dx_grid_abs_pair_c0_0_1 + x_grid_0 - x_grid_1 >= 0
dx_grid_abs_pair_pos_c0_0_1: dx_grid_abs_pair_c0_0_1 - x_grid_0 + x_grid_1 >= 0
```

**代码位置**：```221:227:src/ilp_sub_solution_search.py```

**含义**：
- `dx_grid_abs_pair_c0_0_1` 表示 `|x_grid_0 - x_grid_1|`
- 通过两个约束确保：`dx_grid_abs_pair_c0_0_1 >= |x_grid_0 - x_grid_1|`
- 在最小化目标函数时，会自动取到最小值，即等于绝对值

### 1.2 Grid坐标差的绝对值（Y方向）

**约束名称**：`dy_grid_abs_pair_pos_c0_0_1` 和 `dy_grid_abs_pair_neg_c0_0_1`

**LP文件中的约束**（第43-46行）：
```
dy_grid_abs_pair_neg_c0_0_1: dy_grid_abs_pair_c0_0_1 + y_grid_0 - y_grid_1 >= 0
dy_grid_abs_pair_pos_c0_0_1: dy_grid_abs_pair_c0_0_1 - y_grid_0 + y_grid_1 >= 0
```

**代码位置**：```229:235:src/ilp_sub_solution_search.py```

**含义**：
- `dy_grid_abs_pair_c0_0_1` 表示 `|y_grid_0 - y_grid_1|`
- 同样通过两个约束确保取到绝对值

### 1.3 当前距离定义

**约束名称**：`dist_curr_pair_def_c0_0_1`

**LP文件中的约束**（第27-28行）：
```
dist_curr_pair_def_c0_0_1: dist_curr_pair_c0_0_1 - dx_grid_abs_pair_c0_0_1
 - dy_grid_abs_pair_c0_0_1 = 0
```

**代码位置**：```247:249:src/ilp_sub_solution_search.py```

**含义**：
- `dist_curr_pair_c0_0_1 = dx_grid_abs_pair_c0_0_1 + dy_grid_abs_pair_c0_0_1`
- 这是chiplet对(0,1)之间的曼哈顿距离（grid单位）

---

## 二、计算距离差（与之前解比较）

### 2.1 距离差定义

**约束名称**：`dist_diff_pair_def_c0_0_1_prev0`

**LP文件中的约束**（第33-34行）：
```
dist_diff_pair_def_c0_0_1_prev0: - dist_curr_pair_c0_0_1
 + dist_diff_pair_c0_0_1_prev0 = -25
```

**代码位置**：```285:287:src/ilp_sub_solution_search.py```

**含义**：
- `dist_diff_pair_c0_0_1_prev0 = dist_curr_pair_c0_0_1 - 25`
- 其中 `25` 是之前解（prev0）中chiplet对(0,1)的距离
- 所以 `dist_diff_pair_c0_0_1_prev0` 表示当前距离与之前距离的差值

### 2.2 距离差的绝对值

**约束名称**：`dist_diff_abs_pair_pos_c0_0_1_prev0` 和 `dist_diff_abs_pair_neg_c0_0_1_prev0`

**LP文件中的约束**（第29-32行）：
```
dist_diff_abs_pair_neg_c0_0_1_prev0: dist_diff_abs_pair_c0_0_1_prev0
 + dist_diff_pair_c0_0_1_prev0 >= 0
dist_diff_abs_pair_pos_c0_0_1_prev0: dist_diff_abs_pair_c0_0_1_prev0
 - dist_diff_pair_c0_0_1_prev0 >= 0
```

**代码位置**：```296:302:src/ilp_sub_solution_search.py```

**含义**：
- `dist_diff_abs_pair_c0_0_1_prev0` 表示 `|dist_diff_pair_c0_0_1_prev0|`
- 即当前距离与之前距离的绝对差值

---

## 三、判断距离是否相同（Big-M方法）

### 3.1 相同距离的上界约束

**约束名称**：`same_dist_pair_upper_c0_0_1_prev0`

**LP文件中的约束**（第77-78行）：
```
same_dist_pair_upper_c0_0_1_prev0: dist_diff_abs_pair_c0_0_1_prev0
 + 90 same_dist_pair_c0_0_1_prev0 <= 92.97
```

**代码位置**：```306:308:src/ilp_sub_solution_search.py```

**含义**：
- 如果 `same_dist_pair_c0_0_1_prev0 = 1`（表示距离相同），则：
  - `dist_diff_abs_pair_c0_0_1_prev0 <= 92.97 - 90 = 2.97`
  - 即距离差小于阈值（`min_pair_dist_diff = 3.0`，减去epsilon后约为2.97）
- 如果 `same_dist_pair_c0_0_1_prev0 = 0`，则约束不起作用（因为M=90很大）

**公式**：`dist_diff_abs_ij <= min_pair_dist_diff - epsilon + M * (1 - same_dist_pair_prev)`
- 当 `same_dist_pair_prev = 1` 时：`dist_diff_abs_ij <= min_pair_dist_diff - epsilon`
- 当 `same_dist_pair_prev = 0` 时：约束很宽松（M很大）

### 3.2 相同距离的下界约束

**约束名称**：`same_dist_pair_lower_c0_0_1_prev0`

**LP文件中的约束**（第75-76行）：
```
same_dist_pair_lower_c0_0_1_prev0: dist_diff_abs_pair_c0_0_1_prev0
 + 90 same_dist_pair_c0_0_1_prev0 >= 3
```

**代码位置**：```311:313:src/ilp_sub_solution_search.py```

**含义**：
- 如果 `same_dist_pair_c0_0_1_prev0 = 0`（表示距离不同），则：
  - `dist_diff_abs_pair_c0_0_1_prev0 >= 3`
  - 即距离差必须大于等于阈值（`min_pair_dist_diff = 3.0`）
- 如果 `same_dist_pair_c0_0_1_prev0 = 1`，则约束不起作用

**公式**：`dist_diff_abs_ij >= min_pair_dist_diff - M * same_dist_pair_prev`
- 当 `same_dist_pair_prev = 0` 时：`dist_diff_abs_ij >= min_pair_dist_diff`
- 当 `same_dist_pair_prev = 1` 时：约束很宽松（M很大）

---

## 四、逻辑关系约束

### 4.1 如果diff_dist_pair=1，则same_dist_pair_prev=0

**约束名称**：`diff_dist_pair_implies_not_same_c0_0_1_prev0`

**LP文件中的约束**（第25-26行）：
```
diff_dist_pair_implies_not_same_c0_0_1_prev0: diff_dist_pair_c0_0_1
 + same_dist_pair_c0_0_1_prev0 <= 1
```

**代码位置**：```319:321:src/ilp_sub_solution_search.py```

**含义**：
- 如果 `diff_dist_pair_c0_0_1 = 1`（表示该对距离与所有之前解都不同），则：
  - `same_dist_pair_c0_0_1_prev0 <= 0`，即必须为0
- 逻辑：如果该对距离与所有解都不同，则不能与任何一个解相同

### 4.2 如果same_dist_pair_prev=1，则diff_dist_pair=0

**约束名称**：`not_same_implies_diff_dist_pair_c0_0_1_prev0`

**LP文件中的约束**（第73-74行）：
```
not_same_implies_diff_dist_pair_c0_0_1_prev0: diff_dist_pair_c0_0_1
 + same_dist_pair_c0_0_1_prev0 <= 1
```

**代码位置**：```324:326:src/ilp_sub_solution_search.py```

**含义**：
- 如果 `same_dist_pair_c0_0_1_prev0 = 1`（表示与某个之前解相同），则：
  - `diff_dist_pair_c0_0_1 <= 0`，即必须为0
- 逻辑：如果与任何一个解相同，则不能标记为"与所有解都不同"

**注意**：这个约束与4.1的约束实际上是等价的（都是 `diff_dist_pair + same_dist_pair_prev <= 1`）

### 4.3 如果所有same_dist_pair_prev=0，则diff_dist_pair=1

**约束名称**：`all_not_same_implies_diff_dist_pair_c0_0_1`

**LP文件中的约束**（第5-6行）：
```
all_not_same_implies_diff_dist_pair_c0_0_1: diff_dist_pair_c0_0_1
 + same_dist_pair_c0_0_1_prev0 >= 1
```

**代码位置**：```329:331:src/ilp_sub_solution_search.py```

**含义**：
- 如果 `same_dist_pair_c0_0_1_prev0 = 0`（表示与之前解不同），则：
  - `diff_dist_pair_c0_0_1 >= 1`，即必须为1
- 逻辑：如果与所有之前解都不同，则必须标记为"与所有解都不同"

**注意**：这个约束只针对一个之前解（prev0）。如果有多个之前解，需要所有 `same_dist_pair_prev` 都为0，才能通过约束4.3和4.1的组合使得 `diff_dist_pair = 1`

---

## 五、顶层排除约束

### 5.1 至少有一对chiplet的距离与所有之前解都不同

**约束名称**：`exclude_solution_dist_pair_c0`

**LP文件中的约束**（第47行）：
```
exclude_solution_dist_pair_c0: diff_dist_pair_c0_0_1 >= 1
```

**代码位置**：```333:336:src/ilp_sub_solution_search.py```

**含义**：
- 要求 `diff_dist_pair_c0_0_1 = 1`
- 即chiplet对(0,1)的距离必须与之前所有解都不同
- 这是排除解的核心约束：新解必须至少有一对chiplet的距离与之前所有解都不同

**注意**：如果有多个chiplet对，约束应该是：
```
sum(diff_dist_pair[i,j] for all pairs (i,j)) >= 1
```
但在本例中只有一对chiplet(0,1)，所以直接要求该对必须不同。

---

## 变量说明

### 二进制变量（Binaries）

- `diff_dist_pair_c0_0_1`：chiplet对(0,1)的距离是否与之前所有解都不同
- `same_dist_pair_c0_0_1_prev0`：chiplet对(0,1)的距离是否与之前解0相同

### 连续变量（Continuous）

- `dx_grid_abs_pair_c0_0_1`：chiplet对(0,1)在x方向的grid坐标差的绝对值
- `dy_grid_abs_pair_c0_0_1`：chiplet对(0,1)在y方向的grid坐标差的绝对值
- `dist_curr_pair_c0_0_1`：chiplet对(0,1)的当前距离（grid单位）
- `dist_diff_pair_c0_0_1_prev0`：当前距离与之前解0的距离的差值
- `dist_diff_abs_pair_c0_0_1_prev0`：距离差的绝对值

---

## 约束逻辑总结

1. **计算当前距离**：通过grid坐标计算曼哈顿距离
2. **计算距离差**：与之前解的距离做差，并取绝对值
3. **判断是否相同**：使用Big-M方法，如果距离差 < `min_pair_dist_diff`，则标记为相同
4. **逻辑关系**：确保 `diff_dist_pair` 和 `same_dist_pair_prev` 的逻辑一致性
5. **顶层约束**：至少有一对chiplet的距离与所有之前解都不同

这样设计的目的是确保新解与之前所有解在距离上都有显著差异（至少有一对chiplet的距离差异 >= `min_pair_dist_diff`）。

